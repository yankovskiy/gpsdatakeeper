function leaflet(q){const p={open:undefined,save:undefined,download:undefined};const i=L.featureGroup();const d=new L.Control.Draw({edit:{featureGroup:i},draw:{polygon:false,circle:false,rectangle:false,circlemarker:false,polyline:{shapeOptions:{opacity:1,color:"#ff241c"}}},position:"topright"});var a;var m;var b="My tracks";function h(){function r(u){function w(y){const A=y.name.split(".");const z=A.length;return A[z-1].toLowerCase()}function t(y){return y==="gpx"||y==="kml"}const v=u.files[0];const x=w(v);const s=new FileReader();if(!t(x)){alert("Incorrect file extension");return}s.onload=function(z){const B=new DOMParser();const A=B.parseFromString(z.target.result,"text/xml");const y=x==="gpx"?toGeoJSON.gpx(A):toGeoJSON.kml(A);l(y);a.fitBounds(i.getBounds());p.download.enable();p.save.enable()};s.readAsText(v)}$("#open-file").change(function(){r(this)})}function l(r){var s=L.geoJSON(r);s.eachLayer(function(t){i.addLayer(t);const u=c(t);if(u!==null){t.bindPopup(u)}})}function c(t){function u(x){function w(z,y){return Math.round(z*(Math.pow(10,y)))/(Math.pow(10,y))}return"("+w(x.lat,6)+", "+w(x.lng,6)+")"}if(t instanceof L.Marker||t instanceof L.CircleMarker){return u(t.getLatLng())}else{if(t instanceof L.Polyline){var r=t._defaultShape?t._defaultShape():t.getLatLngs(),v=0;if(r.length<2){return"Distance: N/A"}else{for(var s=0;s<r.length-1;s++){v+=r[s].distanceTo(r[s+1])}return"Distance: "+L.GeometryUtil.readableDistance(v,"metric")}}}return null}function k(){const r=L.easyButton({states:[{icon:"fa-upload",title:"Open drawn data from local file (GPX, KML)",onClick:function(){$("#open-file").click()}}]});const s=L.easyButton({states:[{icon:"fa-save",title:"Save your drawn data to server",onClick:function(){if(f()){$("#save-data-modal").modal("show")}}}]}).disable();const t=L.easyButton({states:[{icon:"fa-download",title:"Download drawn data to local file",onClick:function(){$("#download-data-modal").modal("show")}}]}).disable();p.save=s;p.download=t;p.open=r}function o(A){const v={mapCenter:[0.01,0.01],mapZoom:2,geoData:undefined,isOwner:undefined,isGuest:undefined,gpsDataTitle:b,gpsDataToken:undefined};const s={mapCenter:A.mapCenter!==undefined?A.mapCenter:v.mapCenter,mapZoom:A.mapZoom!==undefined?A.mapZoom:v.mapZoom,geoData:A.geoData,isOwner:A.isOwner,isGuest:A.isGuest,gpsDataTitle:A.gpsDataTitle!==undefined?A.gpsDataTitle:v.gpsDataTitle,gpsDataToken:A.gpsDataToken};const u="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";const z='&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors';const t=L.tileLayer(u,{maxZoom:19,attribution:z});a=new L.Map("map",{center:s.mapCenter,zoom:s.mapZoom,zoomControl:false});i.addTo(a);t.addTo(a);var w={OpenStreetMap:t.addTo(a),OpenTopoMap:L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",{maxZoom:17,attribution:'Map data: &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'}),Satellite:L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community"})};if(A.mapKeys.thunderforest!==""){w.OpenCycleMap=L.tileLayer("https://{s}.tile.thunderforest.com/cycle/{z}/{x}/{y}.png?apikey="+A.mapKeys.thunderforest,{maxZoom:22,attribution:'&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'});w.Outdoor=L.tileLayer("https://{s}.tile.thunderforest.com/outdoors/{z}/{x}/{y}.png?apikey="+A.mapKeys.thunderforest,{maxZoom:22,attribution:'&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'})}L.control.layers(w,{"Show drawing":i},{position:"topright",collapsed:false}).addTo(a);L.control.scale({position:"bottomright"}).addTo(a);k();a.on(L.Draw.Event.DELETED,function(){if(!f()){p.download.disable();p.save.disable()}});a.on(L.Draw.Event.CREATED,function(D){p.download.enable();p.save.enable();const B=D.layer;i.addLayer(B);const C=c(B);if(C!==null){B.bindPopup(C)}});a.on(L.Draw.Event.EDITED,function(C){const D=C.layers;var B=null;D.eachLayer(function(E){B=c(E);if(B!==null){E.setPopupContent(B)}})});var y=true;const r=(s.isGuest!==undefined&&s.isGuest);if(s.geoData!==undefined){const x=JSON.parse(s.geoData);l(x);if(r){p.save.disable();p.open.disable()}else{p.save.enable();p.open.enable()}p.download.enable();if(r||(s.isOwner!==undefined&&!s.isOwner)){y=false}b=s.gpsDataTitle}if(y){a.addControl(d);b=s.gpsDataTitle}L.control.sidebar("sidebar").addTo(a);L.control.locate({position:"topright",icon:"fa fa-location-arrow"}).addTo(a);L.easyBar([p.save,p.open,p.download],{position:"topright"}).addTo(a);g()}function f(){return i.getLayers().length!==0}function g(){e();n();h()}function n(){$("#download-button").click(function(){let fileName=$("#download-file-name").val();const t=$("#download-file-format").val().toLowerCase();if(!fileName.trim()){fileName="data"}let data=j();if(t==="kml"){data=tokml(data)}else{if(t==="gpx"){data=togpx(data)}}const s="application/xml;charset=utf-8,"+encodeURIComponent(data);const r=document.createElement("a");r.setAttribute("href","data:"+s);r.setAttribute("download",fileName+"."+t);r.style.display="none";r.click();$("#download-data-modal").modal("hide")});$("#download-data-modal").on("show.bs.modal",function(r){$("#download-file-name").val(b)})}function e(){$("#save-button").click(function(){const v=$("#gps-data-title").val();function w(){$("#default-form").addClass("has-error")}function t(){$("#save-button").hide();$("#default-form").hide();$("#save-progress").show()}function u(){$("#save-progress").hide();$("#save-error").show()}function r(){$("#save-progress").hide();$("#save-success").show()}function s(){const x=a.getCenter();const z=a.getZoom();const y=JSON.stringify(j());$.post("/map/save-data",{data:y,title:b,token:m,center:[x.lat,x.lng],zoom:z},function(A){if(A.status==="error"){u()}else{if(A.status==="success"){if(A.isOwner===false){a.removeControl(d);p.open.disable()}else{if(!d._map){a.addControl(d)}p.open.enable()}if(A.isGuest){p.save.disable()}else{p.save.enable()}history.pushState(null,null,A.url);m=A.token;r()}}})}if(v!==null&&v.trim().length>0){b=v;t();s()}else{w()}});$("#save-data-modal").on("show.bs.modal",function(r){$("#gps-data-title").val(b);$("#default-form").show().removeClass("has-error");$("#save-button").show();$("#save-success").hide();$("#save-progress").hide();$("#save-error").hide()})}function j(){if(!f()){return null}return i.toGeoJSON()}o(q)};