function leaflet(q){const l=L.featureGroup();const f=new L.Control.Draw({edit:{featureGroup:l},draw:{polygon:false,circle:false,rectangle:false,circlemarker:false,polyline:{shapeOptions:{opacity:1,color:"#ff241c"}}},position:"topright"});var a;var o;var c="My tracks";function i(){$("#save-to-server").click(function(){if(h()){$("#save-data-modal").modal("show")}})}function k(){function r(u){function w(y){const A=y.name.split(".");const z=A.length;return A[z-1].toLowerCase()}function t(y){return y==="gpx"||y==="kml"}const v=u.files[0];const x=w(v);const s=new FileReader();if(!t(x)){alert("Incorrect file extension");return}s.onload=function(z){const B=new DOMParser();const A=B.parseFromString(z.target.result,"text/xml");const y=x==="gpx"?toGeoJSON.gpx(A):toGeoJSON.kml(A);n(y)};s.readAsText(v)}$("#open-file").change(function(){r(this)})}function n(r){var s=L.geoJSON(r);s.eachLayer(function(t){l.addLayer(t);const u=e(t);if(u!==null){t.bindPopup(u)}})}function e(t){function u(x){function w(z,y){return Math.round(z*(Math.pow(10,y)))/(Math.pow(10,y))}return"("+w(x.lat,6)+", "+w(x.lng,6)+")"}if(t instanceof L.Marker||t instanceof L.CircleMarker){return u(t.getLatLng())}else{if(t instanceof L.Polyline){var r=t._defaultShape?t._defaultShape():t.getLatLngs(),v=0;if(r.length<2){return"Distance: N/A"}else{for(var s=0;s<r.length-1;s++){v+=r[s].distanceTo(r[s+1])}return"Distance: "+L.GeometryUtil.readableDistance(v,"metric")}}}return null}function p(z){const v={mapCenter:[0.01,0.01],mapZoom:2,geoData:undefined,isOwner:undefined,isGuest:undefined,gpsDataTitle:c,gpsDataToken:undefined};const r={mapCenter:z.mapCenter!==undefined?z.mapCenter:v.mapCenter,mapZoom:z.mapZoom!==undefined?z.mapZoom:v.mapZoom,geoData:z.geoData,isOwner:z.isOwner,isGuest:z.isGuest,gpsDataTitle:z.gpsDataTitle!==undefined?z.gpsDataTitle:v.gpsDataTitle,gpsDataToken:z.gpsDataToken};const u="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";const y='&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors';const t=L.tileLayer(u,{maxZoom:18,attribution:y});a=new L.Map("map",{center:r.mapCenter,zoom:r.mapZoom,zoomControl:false});l.addTo(a);t.addTo(a);L.control.layers({},{"Show drawing":l},{position:"topright",collapsed:false}).addTo(a);a.on(L.Draw.Event.CREATED,function(C){const A=C.layer;l.addLayer(A);const B=e(A);if(B!==null){A.bindPopup(B)}});a.on(L.Draw.Event.EDITED,function(B){const C=B.layers;var A=null;C.eachLayer(function(D){A=e(D);if(A!==null){D.setPopupContent(A)}})});var x=true;const s=(r.isGuest!==undefined&&r.isGuest);if(r.geoData!==undefined){const w=JSON.parse(r.geoData);n(w);if(s){d()}if(s||(r.isOwner!==undefined&&!r.isOwner)){x=false}}if(x){a.addControl(f);c=r.gpsDataTitle;o=r.gpsDataToken}L.control.sidebar("sidebar").addTo(a);L.control.locate({position:"topright",icon:"glyphicon glyphicon-globe",iconLoading:"glyphicon glyphicon-refresh"}).addTo(a);j()}function h(){return l.getLayers().length!==0}function d(){$(".save-block").remove()}function j(){b("kml");b("gpx");i();g();k()}function g(){$("#save-button").click(function(){const v=$("#gps-data-title").val();function w(){$("#default-form").addClass("has-error")}function t(){$("#save-button").hide();$("#default-form").hide();$("#save-progress").show()}function u(){$("#save-progress").hide();$("#save-error").show()}function r(){$("#save-progress").hide();$("#save-success").show()}function s(){const x=a.getCenter();const z=a.getZoom();const y=JSON.stringify(m());$.post("/map/save-data",{data:y,title:c,token:o,center:[x.lat,x.lng],zoom:z},function(A){if(A.status==="error"){u()}else{if(A.status==="success"){if(A.isOwner===false){a.removeControl(f)}else{a.addControl(f)}if(A.isGuest){d()}history.pushState(null,null,A.url);o=A.token;r()}}})}if(v!==null&&v.trim().length>0){c=v;t();s()}else{w()}});$("#save-data-modal").on("show.bs.modal",function(r){$("#gps-data-title").val(c);$("#default-form").show().removeClass("has-error");$("#save-button").show();$("#save-success").hide();$("#save-progress").hide();$("#save-error").hide()})}function b(t){var s="download-";if(t==="kml"){s+="kml"}else{if(t==="gpx"){s+="gpx"}else{console.error("Unsupported format");return}}const r=document.getElementById(s);r.onclick=function(w){var u=m();if(u===null){return}console.log(JSON.stringify(u));if(t==="kml"){u=tokml(u)}else{if(t==="gpx"){u=togpx(u)}}const v="application/xml;charset=utf-8,"+encodeURIComponent(u);r.setAttribute("href","data:"+v);r.setAttribute("download","data."+t)}}function m(){if(!h()){return null}return l.toGeoJSON()}p(q)};