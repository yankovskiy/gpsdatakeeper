function leaflet(q){const l=L.featureGroup();const f=new L.Control.Draw({edit:{featureGroup:l},draw:{polygon:false,circle:false,rectangle:false,circlemarker:false,polyline:{shapeOptions:{opacity:1,color:"#ff241c"}}},position:"topright"});var a;var o;var c="My tracks";function i(){$("#save-to-server").click(function(){if(h()){$("#save-data-modal").modal("show")}})}function k(){function r(u){function w(y){const A=y.name.split(".");const z=A.length;return A[z-1].toLowerCase()}function t(y){return y==="gpx"||y==="kml"}const v=u.files[0];const x=w(v);const s=new FileReader();if(!t(x)){alert("Incorrect file extension");return}s.onload=function(z){const B=new DOMParser();const A=B.parseFromString(z.target.result,"text/xml");const y=x==="gpx"?toGeoJSON.gpx(A):toGeoJSON.kml(A);n(y);a.fitBounds(l.getBounds())};s.readAsText(v)}$("#open-file").change(function(){r(this)})}function n(r){var s=L.geoJSON(r);s.eachLayer(function(t){l.addLayer(t);const u=e(t);if(u!==null){t.bindPopup(u)}})}function e(t){function u(x){function w(z,y){return Math.round(z*(Math.pow(10,y)))/(Math.pow(10,y))}return"("+w(x.lat,6)+", "+w(x.lng,6)+")"}if(t instanceof L.Marker||t instanceof L.CircleMarker){return u(t.getLatLng())}else{if(t instanceof L.Polyline){var r=t._defaultShape?t._defaultShape():t.getLatLngs(),v=0;if(r.length<2){return"Distance: N/A"}else{for(var s=0;s<r.length-1;s++){v+=r[s].distanceTo(r[s+1])}return"Distance: "+L.GeometryUtil.readableDistance(v,"metric")}}}return null}function p(A){const v={mapCenter:[0.01,0.01],mapZoom:2,geoData:undefined,isOwner:undefined,isGuest:undefined,gpsDataTitle:c,gpsDataToken:undefined};const s={mapCenter:A.mapCenter!==undefined?A.mapCenter:v.mapCenter,mapZoom:A.mapZoom!==undefined?A.mapZoom:v.mapZoom,geoData:A.geoData,isOwner:A.isOwner,isGuest:A.isGuest,gpsDataTitle:A.gpsDataTitle!==undefined?A.gpsDataTitle:v.gpsDataTitle,gpsDataToken:A.gpsDataToken};const u="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";const z='&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors';const t=L.tileLayer(u,{maxZoom:19,attribution:z});a=new L.Map("map",{center:s.mapCenter,zoom:s.mapZoom,zoomControl:false});l.addTo(a);t.addTo(a);var w={OpenStreetMap:t.addTo(a),OpenTopoMap:L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",{maxZoom:17,attribution:'Map data: &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'}),Satellite:L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community"})};if(A.mapKeys.thunderforest!==""){w.OpenCycleMap=L.tileLayer("https://{s}.tile.thunderforest.com/cycle/{z}/{x}/{y}.png?apikey="+A.mapKeys.thunderforest,{maxZoom:22,attribution:'&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'});w.Outdoor=L.tileLayer("https://{s}.tile.thunderforest.com/outdoors/{z}/{x}/{y}.png?apikey="+A.mapKeys.thunderforest,{maxZoom:22,attribution:'&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'})}L.control.layers(w,{"Show drawing":l},{position:"topright",collapsed:false}).addTo(a);L.control.scale({position:"bottomright"}).addTo(a);a.on(L.Draw.Event.CREATED,function(D){const B=D.layer;l.addLayer(B);const C=e(B);if(C!==null){B.bindPopup(C)}});a.on(L.Draw.Event.EDITED,function(C){const D=C.layers;var B=null;D.eachLayer(function(E){B=e(E);if(B!==null){E.setPopupContent(B)}})});var y=true;const r=(s.isGuest!==undefined&&s.isGuest);if(s.geoData!==undefined){const x=JSON.parse(s.geoData);n(x);if(r){d()}if(r||(s.isOwner!==undefined&&!s.isOwner)){y=false}}if(y){a.addControl(f);c=s.gpsDataTitle;o=s.gpsDataToken}L.control.sidebar("sidebar").addTo(a);L.control.locate({position:"topright",icon:"glyphicon glyphicon-globe",iconLoading:"glyphicon glyphicon-refresh"}).addTo(a);j()}function h(){return l.getLayers().length!==0}function d(){$(".save-block").remove()}function j(){b("kml");b("gpx");i();g();k()}function g(){$("#save-button").click(function(){const v=$("#gps-data-title").val();function w(){$("#default-form").addClass("has-error")}function t(){$("#save-button").hide();$("#default-form").hide();$("#save-progress").show()}function u(){$("#save-progress").hide();$("#save-error").show()}function r(){$("#save-progress").hide();$("#save-success").show()}function s(){const x=a.getCenter();const z=a.getZoom();const y=JSON.stringify(m());$.post("/map/save-data",{data:y,title:c,token:o,center:[x.lat,x.lng],zoom:z},function(A){if(A.status==="error"){u()}else{if(A.status==="success"){if(A.isOwner===false){a.removeControl(f)}else{a.addControl(f)}if(A.isGuest){d()}history.pushState(null,null,A.url);o=A.token;r()}}})}if(v!==null&&v.trim().length>0){c=v;t();s()}else{w()}});$("#save-data-modal").on("show.bs.modal",function(r){$("#gps-data-title").val(c);$("#default-form").show().removeClass("has-error");$("#save-button").show();$("#save-success").hide();$("#save-progress").hide();$("#save-error").hide()})}function b(t){var s="download-";if(t==="kml"){s+="kml"}else{if(t==="gpx"){s+="gpx"}else{console.error("Unsupported format");return}}const r=document.getElementById(s);r.onclick=function(w){var u=m();if(u===null){return}console.log(JSON.stringify(u));if(t==="kml"){u=tokml(u)}else{if(t==="gpx"){u=togpx(u)}}const v="application/xml;charset=utf-8,"+encodeURIComponent(u);r.setAttribute("href","data:"+v);r.setAttribute("download","data."+t)}}function m(){if(!h()){return null}return l.toGeoJSON()}p(q)};